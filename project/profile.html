<?php
session_start();

// Initialize goals in session if not already set
if (!isset($_SESSION['goals'])) {
    $_SESSION['goals'] = [];
}

// Check if the user is logged in
if (!isset($_SESSION['username'])) {
    $_SESSION['msg'] = "You must log in first";
    header('location: login.php');
}

if (isset($_GET['logout'])) {
    session_destroy();
    unset($_SESSION['username']);
    header("location: login.php");
}

// Handle adding a new goal
if (isset($_POST['add_goal'])) {
    $goalText = trim($_POST['goal_text']);
    $targetDays = trim($_POST['target_days']); // Capture the target days

    if ($goalText && $targetDays) {
        $startDate = date('Y-m-d'); // Store current date as start date

        $_SESSION['goals'][] = [
            'text' => $goalText, 
            'progress' => 0,
            'target_days' => $targetDays, // Store target days
            'start_date' => $startDate // Store the start date
        ];
    }
    header('location: index.php'); // Redirect to refresh the page with updated goals
}

// Handle removing a goal
if (isset($_GET['remove_goal'])) {
    $goalIndex = $_GET['remove_goal'];
    unset($_SESSION['goals'][$goalIndex]);
    $_SESSION['goals'] = array_values($_SESSION['goals']); // Reindex the array
    header('location: index.php'); // Redirect to refresh the page
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goal Tracker Dashboard</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <style>
        /* Your existing styles */
    </style>
</head>

<body>
    <header>
        <h1>Goal Tracker</h1>
    </header>

    <div class="container" style="display: flex;">
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="top">
                <div class="logo">
                    <img id="logo" src="images/logo1.jpg" alt="Logo" width="100" height="60">
                    <h2>Goal <span class="pink">Tracker</span></h2>
                </div>
            </div>

            <a href="profile.php"><i class="material-icons">person</i>Profile</a><br>
            <label for="goal-type"><i class="material-icons">star</i>Goal Type:</label>
            <select id="goal-type" name="goal-type">
                <option value="short-term">Short-Term</option>
                <option value="long-term">Long-Term</option>
            </select><br>

            <!-- Target Days Input -->
            <label for="target-days"><i class="material-icons">calendar_today</i>Target Days:</label>
            <input type="number" id="target-days" name="target_days" placeholder="Enter days" required><br>

            <p><a href="index.php?logout='1'" style="color: white;"><i class="material-icons">exit_to_app</i>Logout</a></p>
        </div>

        <!-- Main Section -->
        <div class="main-content" id="main-section">
            <h2>Your Goals</h2>

            <!-- Add Goal Form -->
            <form action="index.php" method="POST">
                <input type="text" name="goal_text" placeholder="Enter a new goal" required>
                <input type="number" name="target_days" placeholder="Target Days" required> <!-- Added target days input -->
                <button type="submit" name="add_goal">Add Goal</button>
            </form>

            <div class="goal-list">
                <?php if (count($_SESSION['goals']) > 0): ?>
                    <?php foreach ($_SESSION['goals'] as $index => $goal): ?>
                       <div class="goal-item">
                            <p><strong><?php echo $goal['text']; ?></strong></p>
                            <p>Target Days: <?php echo $goal['target_days']; ?> days</p>
                            <p>Start Date: <?php echo $goal['start_date']; ?></p>
                            <p>Progress: 
                                <?php
                                    // Calculate the progress
                                    $startDate = new DateTime($goal['start_date']);
                                    $currentDate = new DateTime();
                                    $interval = $startDate->diff($currentDate);
                                    $daysPassed = $interval->days;
                                    $daysRemaining = $goal['target_days'] - $daysPassed;
                                    
                                    if ($daysPassed >= $goal['target_days']) {
                                        echo "Goal Completed!";
                                    } else {
                                        echo "$daysPassed days passed, $daysRemaining days remaining";
                                    }
                                ?>
                            </p>
                            <a href="index.php?remove_goal=<?php echo $index; ?>" class="remove-goal" style="color: red;">Remove Goal</a>
                        </div>
                    <?php endforeach; ?>
                <?php else: ?>
                    <p>No goals yet. Add one above!</p>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Handle validation for "Target Days" input (ensure it's a positive integer)
            const targetDaysInput = document.querySelector('input[name="target_days"]');
            targetDaysInput.addEventListener('input', function (e) {
                const value = e.target.value;
                // Only allow positive integers for target days
                if (value && value <= 0) {
                    e.target.setCustomValidity('Please enter a valid number of target days');
                } else {
                    e.target.setCustomValidity('');
                }
            });

            // Handle form submission validation (Goal Text and Target Days)
            const addGoalForm = document.querySelector('form[action="index.php"]');
            addGoalForm.addEventListener('submit', function (event) {
                const goalTextInput = addGoalForm.querySelector('input[name="goal_text"]');
                const targetDaysInput = addGoalForm.querySelector('input[name="target_days"]');
                
                const goalText = goalTextInput.value.trim();
                const targetDaysValue = targetDaysInput.value;

                if (!goalText || !targetDaysValue || targetDaysValue <= 0) {
                    event.preventDefault(); // Prevent form submission
                    alert('Please provide a valid goal description and target days');
                }
            });
        });
    </script>
</body>
</html>
